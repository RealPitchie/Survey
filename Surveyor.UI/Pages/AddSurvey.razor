@page "/AddSurvey"

@using Surveyor.Persistence
@using Surveyor.Domain.Models 
@using WebComponents
@using Microsoft.AspNetCore.Components

@inject SurveyRepository Repo
@inject NavigationManager NavManager

<h3 style="text-align: center; width: auto">Новый опрос</h3>
<div>
    <div style="margin: 15px auto; max-width: 500px">
        <MudTextField @bind-Value="_newSurvey.Name" Placeholder="Название" T="string"></MudTextField>
        <MudTextField @bind-Value="_newSurvey.Author" Placeholder="Автор" T="string"></MudTextField> 
        <MudTextField @bind-Value="_newSurvey.Description" Lines="5" Placeholder="Описание"></MudTextField>
    </div>
    <div style="margin: 15px auto; max-width: 500px">
        <h3>Поля опроса</h3>
        @* <MudButton Size="Size.Small" Variant="Variant.Outlined" Style="margin-bottom: 15px" OnClick="AddSurveyField"> *@
        @*     Добавить поле *@
        @* </MudButton> *@
        <div class="row" >
            @foreach (var field in _newSurvey.Items)
            {
                <MudCard Elevation="3" Outlined="true" Style="width: 150px; margin: 10px; padding: 5px">
                    <p> @field.Name</p>
                    <p>@FieldTypeToString(field)</p>
                </MudCard>
            }
        </div>
         <SurveyItemField Item="new SurveyItem { Id = Guid.NewGuid().ToString(), Options = string.Empty }" OnSubmit="(args) => AddNewField(args)" />
    </div>
    <div style="margin: 15px auto; max-width: 500px">
        <MudButton OnClick="Submit" Style="margin-top: 15px" Variant="Variant.Outlined" Color="Color.Primary">Сохранить</MudButton>
    </div>
</div>  

@code { 
    readonly Survey _newSurvey = new() {Id = Guid.NewGuid().ToString(), Items = new List<SurveyItem>()};

    SurveyItem Item = new(); 

    async Task Submit()
    {
        _newSurvey.CreatedAt = DateTime.Now;
        await Repo.AddSurvey(_newSurvey);
        NavManager.NavigateTo("/", true);
    }

    private  void AddNewField(SurveyItem field)
    {
        _newSurvey.Items.Add(field);
    }

    string FieldTypeToString(SurveyItem field)
    {
        return field.Type switch
        {
            ItemType.Text => "Текст",
            ItemType.List => "Список",
            ItemType.YesNo => "Да / нет"
        };
    }
 
}